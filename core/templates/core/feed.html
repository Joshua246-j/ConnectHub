{% extends "core/base.html" %} {% load static %} {% block content %}

<div class="flex flex-col md:flex-row justify-center gap-6 px-2 md:px-0">
  <!-- üì∞ Center Feed -->
  <div class="flex-1 max-w-2xl space-y-6">
    <!-- üì∏ Stories Carousel -->
    <div
      class="relative bg-white dark:bg-gray-800 rounded-3xl shadow-md p-3 md:p-4"
    >
      <div id="storiesWrapper" class="relative">
        <div
          id="storiesContainer"
          class="flex items-center space-x-4 md:space-x-6 overflow-x-auto scrollbar-hide scroll-smooth px-1 md:px-2 py-2"
        >
          <!-- Add Your Story -->
          <form
            method="POST"
            enctype="multipart/form-data"
            action="{% url 'add_story' %}"
            class="flex flex-col items-center space-y-1 md:space-y-2 flex-shrink-0"
          >
            {% csrf_token %}
            <label for="storyInput" class="cursor-pointer">
              <div
                class="w-16 h-16 md:w-20 md:h-20 flex items-center justify-center border-4 border-blue-400 rounded-full text-3xl font-bold hover:bg-gray-100 dark:hover:bg-gray-700 transition"
              >
                +
              </div>
            </label>
            <p class="text-[10px] md:text-xs text-gray-600 dark:text-gray-300">
              Add Story
            </p>
            <input
              type="file"
              id="storyInput"
              name="image"
              accept="image/*"
              class="hidden"
              onchange="this.form.submit()"
            />
          </form>

          <!-- Existing Stories -->
          {% for story in stories %}
          <div
            class="relative flex flex-col items-center space-y-1 md:space-y-2 flex-shrink-0"
          >
            {% if story.image %}
            <img
              src="{{ story.image.url }}"
              class="w-16 h-16 md:w-20 md:h-20 rounded-full border-4 border-blue-400 object-cover story-thumb cursor-pointer transition hover:scale-105"
              data-story="{{ story.image.url }}"
              onclick="openStoryModal(this)"
            />
            {% else %}
            <div
              class="w-16 h-16 md:w-20 md:h-20 bg-gray-300 dark:bg-gray-700 rounded-full flex items-center justify-center text-xl font-semibold text-gray-700 dark:text-gray-300"
            >
              {{ story.user.user.username|first|upper }}
            </div>
            {% endif %}
            <p
              class="text-[10px] md:text-xs truncate w-16 md:w-20 text-center text-gray-700 dark:text-gray-300"
            >
              {{ story.user.user.username }}
            </p>

            {% if request.user == story.user.user %}
            <form
              method="POST"
              action="{% url 'delete_story' story.id %}"
              class="absolute -top-1 -right-1"
            >
              {% csrf_token %}
              <button
                class="text-xs text-white bg-red-500 hover:bg-red-600 rounded-full w-4 h-4 flex items-center justify-center"
              >
                √ó
              </button>
            </form>
            {% endif %}
          </div>
          {% endfor %}
        </div>

        <!-- Scroll Buttons (hidden on mobile) -->
        <button
          id="scrollLeft"
          class="hidden md:flex absolute left-0 top-1/2 transform -translate-y-1/2 bg-gray-100 dark:bg-gray-700 p-3 rounded-full shadow-md hover:scale-105 transition z-20"
        >
          <i data-feather="chevron-left"></i>
        </button>
        <button
          id="scrollRight"
          class="hidden md:flex absolute right-0 top-1/2 transform -translate-y-1/2 bg-gray-100 dark:bg-gray-700 p-3 rounded-full shadow-md hover:scale-105 transition z-20"
        >
          <i data-feather="chevron-right"></i>
        </button>
      </div>
    </div>

    <!-- üìù Posts Feed -->
    <div class="space-y-6">
      {% for post in posts %}
      <div
        class="bg-white dark:bg-gray-800 rounded-2xl shadow-md p-3 md:p-4 relative hover:shadow-lg transition"
      >
        {% if request.user == post.user.user %}
        <form
          method="POST"
          action="{% url 'delete_post' post.id %}"
          class="absolute top-2 right-2"
        >
          {% csrf_token %}
          <button
            class="text-xs md:text-sm text-red-500 hover:text-red-600 font-bold"
          >
            Delete
          </button>
        </form>
        {% endif %}

        <!-- Post Header -->
        <div class="flex items-center space-x-3 mb-3">
          {% if post.user.profile_pic %}
          <a href="{% url 'profile' post.user.id %}">
            <img
              src="{{ post.user.profile_pic.url }}"
              class="w-8 h-8 md:w-10 md:h-10 rounded-full object-cover"
            />
          </a>
          {% else %}
          <a href="{% url 'profile' post.user.id %}">
            <div
              class="w-8 h-8 md:w-10 md:h-10 bg-gray-300 dark:bg-gray-700 rounded-full flex items-center justify-center text-gray-700 dark:text-gray-300 font-medium"
            >
              {{ post.user.user.username|first|upper }}
            </div>
          </a>
          {% endif %}
          <p
            class="font-semibold text-gray-800 dark:text-gray-100 text-sm md:text-base"
          >
            <a href="{% url 'profile' post.user.id %}" class="hover:underline"
              >{{ post.user.user.username }}</a
            >
          </p>
        </div>

        <!-- Post Media -->
        {% for media in post.media.all %}
        <div class="mb-3 rounded-lg overflow-hidden">
          {% if media.is_video %}
          <video controls class="w-full rounded-lg">
            <source src="{{ media.file.url }}" type="video/mp4" />
          </video>
          {% else %}
          <img
            src="{{ media.file.url }}"
            class="w-full object-cover rounded-lg"
          />
          {% endif %}
        </div>
        {% endfor %}

        <!-- Likes -->
        <form
          method="POST"
          action="{% url 'toggle_like' post.id %}"
          class="mb-2"
        >
          {% csrf_token %}
          <button
            class="flex items-center space-x-1 text-blue-500 hover:text-blue-600 font-medium transition"
          >
            <span>‚ù§Ô∏è</span>
            <span>{{ post.likes.count }} Likes</span>
          </button>
        </form>

        <!-- Caption -->
        {% if post.caption %}
        <p
          class="text-gray-700 dark:text-gray-300 text-sm break-words line-clamp-5"
        >
          {{ post.caption|escape }}
        </p>
        {% if post.caption|length > 300 %}
        <button
          class="text-blue-500 dark:text-blue-400 text-xs mt-1 hover:underline"
          onclick="this.previousElementSibling.classList.toggle('line-clamp-5'); this.textContent = this.textContent === 'Read more' ? 'Show less' : 'Read more';"
        >
          Read more
        </button>
        {% endif %} {% endif %}
      </div>
      {% empty %}
      <p class="text-gray-500 dark:text-gray-400 text-sm text-center mt-4">
        No posts yet.
      </p>
      {% endfor %}
    </div>
  </div>

  <!-- üìù Right Side (hidden on mobile) -->
  <div class="hidden md:block w-80 flex-shrink-0 sticky top-6 h-fit space-y-6">
    <div
      class="bg-white dark:bg-gray-800 rounded-2xl shadow-md p-4 flex flex-col space-y-3"
    >
      {% include "core/create_post_form.html" %}
    </div>
  </div>
</div>

<!-- ‚úÖ Mobile Create Post Button -->
<div class="fixed bottom-16 right-4 md:hidden">
  <button
    onclick="document.getElementById('mobilePostModal').classList.remove('hidden')"
    class="bg-blue-600 hover:bg-blue-700 text-white p-4 rounded-full shadow-lg"
  >
    <i data-feather="plus"></i>
  </button>
</div>

<!-- Mobile Post Modal -->
<div
  id="mobilePostModal"
  class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center"
>
  <div class="bg-white dark:bg-gray-800 p-4 rounded-xl w-11/12 max-w-md">
    <h3 class="text-lg font-semibold mb-2 text-center">Create Post</h3>
    {% include "core/create_post_form.html" %}
    <button
      onclick="document.getElementById('mobilePostModal').classList.add('hidden')"
      class="mt-3 w-full text-center text-red-500 hover:underline"
    >
      Cancel
    </button>
  </div>
</div>

<script>
  feather.replace();
</script>
{% endblock %}
