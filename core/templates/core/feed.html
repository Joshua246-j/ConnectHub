{% extends "core/base.html" %}
{% load static %}
{% block content %}
<div class="flex flex-col md:flex-row justify-center gap-6 px-4 md:px-0">
  <!-- üì∞ Center Feed -->
  <div class="flex-1 max-w-2xl space-y-6">
    <!-- üì∏ Stories Carousel -->
    <div class="relative bg-white dark:bg-gray-800 rounded-3xl shadow-md p-4">
      <div id="storiesWrapper" class="relative">
        <div
          id="storiesContainer"
          class="flex items-center space-x-6 overflow-x-auto scrollbar-hide scroll-smooth px-2 py-2"
        >
          <!-- Add Your Story -->
          <form method="POST" enctype="multipart/form-data" action="{% url 'add_story' %}" class="flex flex-col items-center space-y-2 flex-shrink-0">
            {% csrf_token %}
            <label for="storyInput" class="cursor-pointer">
              <div class="w-20 h-20 flex items-center justify-center border-4 border-blue-400 rounded-full text-3xl font-bold hover:bg-gray-100 dark:hover:bg-gray-700 transition">+</div>
            </label>
            <p class="text-xs text-gray-600 dark:text-gray-300">Add Story</p>
            <input type="file" id="storyInput" name="image" accept="image/*" class="hidden" onchange="this.form.submit()" />
          </form>

          <!-- Existing Stories -->
          {% for story in stories %}
          <div class="relative flex flex-col items-center space-y-2 flex-shrink-0">
            {% if story.image %}
            <img src="{{ story.image.url }}" class="w-20 h-20 rounded-full border-4 border-blue-400 object-cover story-thumb cursor-pointer transition hover:scale-105" data-story="{{ story.image.url }}" alt="Story" onclick="openStoryModal(this)" />
            {% else %}
            <div class="w-20 h-20 bg-gray-300 dark:bg-gray-700 rounded-full flex items-center justify-center text-xl font-semibold text-gray-700 dark:text-gray-300">{{ story.user.user.username|first|upper }}</div>
            {% endif %}
            <p class="text-xs truncate w-20 text-center text-gray-700 dark:text-gray-300">{{ story.user.user.username }}</p>

            {% if request.user == story.user.user %}
            <form method="POST" action="{% url 'delete_story' story.id %}" class="absolute -top-1 -right-1">
              {% csrf_token %}
              <button class="text-xs text-white bg-red-500 hover:bg-red-600 rounded-full w-4 h-4 flex items-center justify-center">√ó</button>
            </form>
            {% endif %}
          </div>
          {% endfor %}
        </div>

        <!-- Scroll Buttons -->
        <button id="scrollLeft" class="absolute left-0 top-1/2 transform -translate-y-1/2 bg-gray-100 dark:bg-gray-700 p-3 rounded-full shadow-md hover:scale-105 transition z-20 hidden">
          <i data-feather="chevron-left"></i>
        </button>
        <button id="scrollRight" class="absolute right-0 top-1/2 transform -translate-y-1/2 bg-gray-100 dark:bg-gray-700 p-3 rounded-full shadow-md hover:scale-105 transition z-20 hidden">
          <i data-feather="chevron-right"></i>
        </button>
      </div>
    </div>

    <!-- üìù Posts Feed -->
    <div class="space-y-6">
      {% for post in posts %}
      <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-md p-4 relative hover:shadow-lg transition">
        {% if request.user == post.user.user %}
        <form method="POST" action="{% url 'delete_post' post.id %}" class="absolute top-2 right-2">
          {% csrf_token %}
          <button class="text-sm text-red-500 hover:text-red-600 font-bold">Delete</button>
        </form>
        {% endif %}

        <!-- Post Header -->
        <div class="flex items-center space-x-3 mb-3">
          {% if post.user.profile_pic %}
          <a href="{% url 'profile' post.user.id %}"><img src="{{ post.user.profile_pic.url }}" class="w-10 h-10 rounded-full object-cover"/></a>
          {% else %}
          <a href="{% url 'profile' post.user.id %}"><div class="w-10 h-10 bg-gray-300 dark:bg-gray-700 rounded-full flex items-center justify-center text-gray-700 dark:text-gray-300 font-medium">{{ post.user.user.username|first|upper }}</div></a>
          {% endif %}
          <p class="font-semibold text-gray-800 dark:text-gray-100"><a href="{% url 'profile' post.user.id %}" class="hover:underline">{{ post.user.user.username }}</a></p>
        </div>

        <!-- Post Media -->
        {% for media in post.media.all %}
        <div class="mb-3 rounded-lg overflow-hidden">
          {% if media.is_video %}
          <video controls class="w-full rounded-lg">
            <source src="{{ media.file.url }}" type="video/mp4" />Your browser does not support the video tag.
          </video>
          {% else %}
          <img src="{{ media.file.url }}" class="w-full object-cover rounded-lg"/>
          {% endif %}
        </div>
        {% endfor %}

        <!-- Likes -->
        <form method="POST" action="{% url 'toggle_like' post.id %}" class="mb-2">
          {% csrf_token %}
          <button class="flex items-center space-x-1 text-blue-500 hover:text-blue-600 font-medium transition"><span>‚ù§Ô∏è</span><span>{{ post.likes.count }} Likes</span></button>
        </form>

        <!-- Caption -->
        {% if post.caption %}
        <div class="relative">
          <p class="text-gray-700 dark:text-gray-300 text-sm break-words line-clamp-5">{{ post.caption|escape }}</p>
          {% if post.caption|length > 300 %}
          <button class="text-blue-500 dark:text-blue-400 text-xs mt-1 hover:underline" onclick="this.previousElementSibling.classList.toggle('line-clamp-5'); this.textContent = this.textContent === 'Read more' ? 'Show less' : 'Read more';">Read more</button>
          {% endif %}
        </div>
        {% endif %}
      </div>
      {% empty %}
      <p class="text-gray-500 dark:text-gray-400 text-sm text-center mt-4">No posts yet.</p>
      {% endfor %}
    </div>
  </div>

  <!-- üìù Right Side: Modern Create Post -->
  <div class="w-full md:w-80 flex-shrink-0 mt-6 md:mt-0">
    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-md p-4 flex flex-col space-y-3">
      <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-100 border-b border-gray-200 dark:border-gray-700 pb-2">Create Post</h3>

      <form method="POST" enctype="multipart/form-data" action="{% url 'feed' %}">
        {% csrf_token %}
        <textarea name="caption" rows="3" placeholder="What's on your mind?" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-full focus:outline-none focus:ring-2 focus:ring-blue-400 resize-none text-sm transition dark:bg-gray-700 dark:text-gray-100"></textarea>

        <div class="flex flex-col md:flex-row justify-between mt-2 space-y-2 md:space-y-0 md:space-x-2">
          <label class="flex-1 flex items-center justify-center px-2 py-2 border border-gray-300 dark:border-gray-600 rounded-full cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-700 dark:text-gray-300 transition">
            <i data-feather="image" class="mr-2"></i> Photo
            <input type="file" name="media" multiple accept="image/*" class="hidden" id="imageInput" />
          </label>

          <label class="flex-1 flex items-center justify-center px-2 py-2 border border-gray-300 dark:border-gray-600 rounded-full cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-700 dark:text-gray-300 transition">
            <i data-feather="video" class="mr-2"></i> Video
            <input type="file" name="media" multiple accept="video/*" class="hidden" id="videoInput" />
          </label>
        </div>

        <span id="mediaSelected" class="text-xs text-gray-500 dark:text-gray-400 hidden mt-1"></span>

        <button type="submit" name="submit_post" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold px-4 py-2 rounded-full shadow-md transition mt-2 flex items-center justify-center space-x-2">
          <i data-feather="send"></i><span>Post</span>
        </button>
      </form>
    </div>
  </div>
</div>

<!-- Story Modal -->
<div id="storyModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center hidden z-50">
  <img id="storyModalImg" class="max-h-[90%] max-w-[90%] rounded-lg" src="" alt="Story"/>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const storiesContainer = document.getElementById("storiesContainer");
  const scrollLeft = document.getElementById("scrollLeft");
  const scrollRight = document.getElementById("scrollRight");

  const updateButtons = () => {
    scrollLeft.classList.toggle("hidden", storiesContainer.scrollLeft <= 0);
    scrollRight.classList.toggle("hidden", storiesContainer.scrollLeft >= storiesContainer.scrollWidth - storiesContainer.clientWidth - 10);
  };

  scrollLeft.addEventListener("click", () => { storiesContainer.scrollBy({ left: -200, behavior: "smooth" }); setTimeout(updateButtons, 300); });
  scrollRight.addEventListener("click", () => { storiesContainer.scrollBy({ left: 200, behavior: "smooth" }); setTimeout(updateButtons, 300); });
  updateButtons();
  storiesContainer.addEventListener("scroll", updateButtons);

  const mediaInput = document.getElementById("imageInput");
  const videoInput = document.getElementById("videoInput");
  const mediaSelected = document.getElementById("mediaSelected");

  function updateSelected() {
    let totalFiles = (mediaInput.files.length || 0) + (videoInput.files.length || 0);
    if (totalFiles) {
      mediaSelected.textContent = "üìÅ " + totalFiles + " file(s) selected";
      mediaSelected.classList.remove("hidden");
    } else { mediaSelected.classList.add("hidden"); }
  }

  mediaInput.addEventListener("change", updateSelected);
  videoInput.addEventListener("change", updateSelected);

  window.openStoryModal = function(el) {
    const modal = document.getElementById("storyModal");
    const modalImg = document.getElementById("storyModalImg");
    modalImg.src = el.dataset.story;
    modal.classList.remove("hidden");
  };

  document.getElementById("storyModal").addEventListener("click", () => { document.getElementById("storyModal").classList.add("hidden"); });

  feather.replace();
});
</script>
{% endblock %}
