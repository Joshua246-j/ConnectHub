{% extends "core/base.html" %}
{% load static %}
{% block content %}

<div class="flex flex-col md:flex-row justify-center gap-6 px-4 md:px-0">

  <!-- üì∞ Center Feed -->
  <div class="flex-1 max-w-2xl space-y-6">

    <!-- üì∏ Stories Carousel -->
    <div class="relative bg-white dark:bg-gray-800 rounded-3xl shadow-md p-4">
      <div id="storiesWrapper" class="relative">

        <!-- Stories Container -->
        <div id="storiesContainer" class="flex flex-nowrap items-center space-x-2 md:space-x-4 overflow-x-auto scrollbar-hide scroll-smooth px-2 py-2 snap-x snap-mandatory">

          <!-- Add Your Story -->
          <form method="POST" enctype="multipart/form-data" action="{% url 'add_story' %}" class="flex flex-col items-center space-y-1 flex-shrink-0 w-1/3 sm:w-16 md:w-20 snap-start">
            {% csrf_token %}
            <label for="storyInput" class="cursor-pointer">
              <div class="w-16 h-16 sm:w-16 sm:h-16 md:w-20 md:h-20 flex items-center justify-center border-4 border-blue-400 rounded-full text-2xl md:text-3xl font-bold hover:bg-gray-100 dark:hover:bg-gray-700 transition">+</div>
            </label>
            <p class="text-xs text-gray-600 dark:text-gray-300 truncate w-16 sm:w-16 md:w-20 text-center">Add Story</p>
            <input type="file" id="storyInput" name="image" accept="image/*" class="hidden" onchange="this.form.submit()" />
          </form>

          <!-- Existing Stories -->
          {% for story in stories %}
          <div class="relative flex flex-col items-center space-y-1 flex-shrink-0 w-1/3 sm:w-16 md:w-20 snap-start">
            {% if story.image %}
            <img src="{{ story.image.url }}" class="w-16 h-16 sm:w-16 sm:h-16 md:w-20 md:h-20 rounded-full border-4 border-blue-400 object-cover cursor-pointer hover:scale-105 transition" data-story="{{ story.image.url }}" alt="Story" onclick="openStoryModal(this)" />
            {% else %}
            <div class="w-16 h-16 sm:w-16 sm:h-16 md:w-20 md:h-20 bg-gray-300 dark:bg-gray-700 rounded-full flex items-center justify-center text-gray-700 dark:text-gray-300 font-semibold">{{ story.user.user.username|first|upper }}</div>
            {% endif %}
            <p class="text-xs truncate w-16 sm:w-16 md:w-20 text-center text-gray-700 dark:text-gray-300">{{ story.user.user.username }}</p>

            {% if request.user == story.user.user %}
            <form method="POST" action="{% url 'delete_story' story.id %}" class="absolute -top-1 -right-1 z-10">
              {% csrf_token %}
              <button class="text-xs text-white bg-red-500 hover:bg-red-600 rounded-full w-4 h-4 flex items-center justify-center">√ó</button>
            </form>
            {% endif %}
          </div>
          {% endfor %}

        </div>
      </div>
    </div>

    <!-- üìù Posts Feed -->
    <div class="space-y-6">
      {% for post in posts %}
      <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-md p-4 relative hover:shadow-lg transition">

        {% if request.user == post.user.user %}
        <form method="POST" action="{% url 'delete_post' post.id %}" class="absolute top-2 right-2">
          {% csrf_token %}
          <button class="text-sm text-red-500 hover:text-red-600 font-bold">Delete</button>
        </form>
        {% endif %}

        <!-- Post Header -->
        <div class="flex items-center space-x-3 mb-3">
          {% if post.user.profile_pic %}
          <a href="{% url 'profile' post.user.id %}"><img src="{{ post.user.profile_pic.url }}" class="w-10 h-10 rounded-full object-cover"/></a>
          {% else %}
          <a href="{% url 'profile' post.user.id %}"><div class="w-10 h-10 bg-gray-300 dark:bg-gray-700 rounded-full flex items-center justify-center text-gray-700 dark:text-gray-300 font-medium">{{ post.user.user.username|first|upper }}</div></a>
          {% endif %}
          <p class="font-semibold text-gray-800 dark:text-gray-100"><a href="{% url 'profile' post.user.id %}" class="hover:underline">{{ post.user.user.username }}</a></p>
        </div>

        <!-- Post Media -->
        {% for media in post.media.all %}
        <div class="mb-3 rounded-lg overflow-hidden">
          {% if media.is_video %}
          <video controls class="w-full rounded-lg max-h-[500px] md:max-h-none">
            <source src="{{ media.file.url }}" type="video/mp4" />Your browser does not support the video tag.
          </video>
          {% else %}
          <img src="{{ media.file.url }}" class="w-full object-cover rounded-lg max-h-[500px] md:max-h-none"/>
          {% endif %}
        </div>
        {% endfor %}

        <!-- Likes -->
        <form method="POST" action="{% url 'toggle_like' post.id %}" class="mb-2">
          {% csrf_token %}
          <button class="flex items-center space-x-1 text-blue-500 hover:text-blue-600 font-medium transition"><span>‚ù§Ô∏è</span><span>{{ post.likes.count }} Likes</span></button>
        </form>

        <!-- Caption -->
        {% if post.caption %}
        <div class="relative">
          <p class="text-gray-700 dark:text-gray-300 text-sm break-words line-clamp-5">{{ post.caption|escape }}</p>
          {% if post.caption|length > 300 %}
          <button class="text-blue-500 dark:text-blue-400 text-xs mt-1 hover:underline" onclick="this.previousElementSibling.classList.toggle('line-clamp-5'); this.textContent = this.textContent === 'Read more' ? 'Show less' : 'Read more';">Read more</button>
          {% endif %}
        </div>
        {% endif %}

      </div>
      {% empty %}
      <p class="text-gray-500 dark:text-gray-400 text-sm text-center mt-4">No posts yet.</p>
      {% endfor %}
    </div>

  </div>

  <!-- üìù Right Side: Desktop Create Post -->
  <div class="hidden md:block w-80 flex-shrink-0 mt-6 md:mt-0">
    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-md p-4 flex flex-col space-y-3">
      <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-100 border-b border-gray-200 dark:border-gray-700 pb-2">Create Post</h3>
      <form method="POST" enctype="multipart/form-data" action="{% url 'feed' %}">
        {% csrf_token %}
        <textarea name="caption" rows="3" placeholder="What's on your mind?" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-full focus:outline-none focus:ring-2 focus:ring-blue-400 resize-none text-sm transition dark:bg-gray-700 dark:text-gray-100"></textarea>
        <div class="flex flex-col md:flex-row justify-between mt-2 space-y-2 md:space-y-0 md:space-x-2">
          <label class="flex-1 flex items-center justify-center px-2 py-2 border border-gray-300 dark:border-gray-600 rounded-full cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-700 dark:text-gray-300 transition">
            <i data-feather="image" class="mr-2"></i> Photo
            <input type="file" id="imageInput" name="media" multiple accept="image/*" class="hidden" />
          </label>
          <label class="flex-1 flex items-center justify-center px-2 py-2 border border-gray-300 dark:border-gray-600 rounded-full cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-700 dark:text-gray-300 transition">
            <i data-feather="video" class="mr-2"></i> Video
            <input type="file" id="videoInput" name="media" multiple accept="video/*" class="hidden" />
          </label>
        </div>
        <span id="mediaSelected" class="text-xs text-gray-500 dark:text-gray-400 hidden mt-1"></span>
        <button type="submit" name="submit_post" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold px-4 py-2 rounded-full shadow-md transition mt-2 flex items-center justify-center space-x-2">
          <i data-feather="send"></i><span>Post</span>
        </button>
      </form>
    </div>
  </div>
</div>

<!-- Mobile Floating Create Post -->
<button id="mobileCreateBtn" class="md:hidden fixed bottom-6 right-6 bg-blue-500 text-white p-4 rounded-full shadow-lg hover:bg-blue-600 z-[9999] flex items-center justify-center transition">
  <i data-feather="plus" class="w-6 h-6"></i>
</button>

<!-- Mobile Create Post Modal -->
<div id="mobileCreateModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-start justify-center hidden z-[9999] p-4 pt-16">
  <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-md w-full max-w-md p-4 relative">
    <button id="closeMobileCreate" class="absolute top-2 right-2 text-gray-700 dark:text-gray-300 font-bold text-xl">&times;</button>
    <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-100 border-b border-gray-200 dark:border-gray-700 pb-2">Create Post</h3>
    <form method="POST" enctype="multipart/form-data" action="{% url 'feed' %}">
      {% csrf_token %}
      <textarea name="caption" rows="3" placeholder="What's on your mind?" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-full focus:outline-none focus:ring-2 focus:ring-blue-400 resize-none text-sm transition dark:bg-gray-700 dark:text-gray-100"></textarea>
      <div class="flex flex-col mt-2 space-y-2">
        <label class="flex-1 flex items-center justify-center px-2 py-2 border border-gray-300 dark:border-gray-600 rounded-full cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-700 dark:text-gray-300 transition">
          <i data-feather="image" class="mr-2"></i> Photo
          <input type="file" id="imageInputMobile" name="media[]" multiple accept="image/*" class="hidden" />
        </label>
        <label class="flex-1 flex items-center justify-center px-2 py-2 border border-gray-300 dark:border-gray-600 rounded-full cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-700 dark:text-gray-300 transition">
          <i data-feather="video" class="mr-2"></i> Video
          <input type="file" id="videoInputMobile" name="media[]" multiple accept="video/*" class="hidden" />
        </label>
      </div>
      <button type="submit" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold px-4 py-2 rounded-full shadow-md mt-2 flex items-center justify-center space-x-2">
        <i data-feather="send"></i><span>Post</span>
      </button>
    </form>
  </div>
</div>

<!-- Story Modal -->
<div id="storyModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center hidden z-[9999]">
  <img id="storyModalImg" class="max-h-[90%] max-w-[90%] rounded-lg" src="" alt="Story"/>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  // Story modal
  window.openStoryModal = function(el) { 
    document.getElementById("storyModal").classList.remove("hidden"); 
    document.getElementById("storyModalImg").src = el.dataset.story; 
  };
  document.getElementById("storyModal").addEventListener("click", () => { 
    document.getElementById("storyModal").classList.add("hidden"); 
  });

  // Mobile Create Post modal
  const mobileBtn = document.getElementById("mobileCreateBtn");
  const mobileModal = document.getElementById("mobileCreateModal");
  const closeMobile = document.getElementById("closeMobileCreate");
  mobileBtn.addEventListener("click", () => mobileModal.classList.remove("hidden"));
  closeMobile.addEventListener("click", () => mobileModal.classList.add("hidden"));

  // Feather icons
  feather.replace();

  // Desktop: Show selected file names
  const imageInput = document.getElementById("imageInput");
  const videoInput = document.getElementById("videoInput");
  const mediaSelected = document.getElementById("mediaSelected");

  function updateMediaSelected() {
    let files = [];
    if(imageInput.files.length) files = [...files, ...Array.from(imageInput.files).map(f => f.name)];
    if(videoInput.files.length) files = [...files, ...Array.from(videoInput.files).map(f => f.name)];
    if(files.length) {
      mediaSelected.textContent = files.join(', ');
      mediaSelected.classList.remove('hidden');
    } else {
      mediaSelected.textContent = '';
      mediaSelected.classList.add('hidden');
    }
  }

  imageInput.addEventListener("change", updateMediaSelected);
  videoInput.addEventListener("change", updateMediaSelected);
});
</script>

{% endblock %}
